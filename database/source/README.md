# Подготовка базы данных

 В качестве основы была взята часть реальной базы данных сервиса [DeliveryClub](https://www.delivery-club.ru/moscow), пользуясь [парсером HTML страниц, написанным на языке python.](https://github.com/DavidaaWoW/GlobusDelievery/blob/master/database/source/parser.py)
 Внутри данного парсера, последовательно были обработаны 3 вида сущностей: рестораны, категории и блюда. Из ```HTML``` страниц были выгружены все необходимые данные, для формирования БД.
 В результате работы парсера, были сгенерированы 3 ```CSV``` файла, по одному на каждую сущность соответственно. Файлы были помещены в директорию [source](https://github.com/DavidaaWoW/GlobusDelievery/tree/master/database/source). Каждой сущности, с помощью excel формулы был сгенерирован уникальный идентификатор.
 
 ## Триггеры для корректного импорта данных
 
 В процессе разработке возникла задача - импортировать все данные из ```CSV``` файлов, при этом расставить корректно связи между всеми сущностями. Сложность заключалась в том, что все идентификаторы были сгенерированы вручную и независимо уже после парсинга данных.
 Наиболее быстрым и эффективным решением стало написание триггеров ```MySQL```. К сожалению, для реализации функционала пришлось принебречь правилом [избыточности информации](https://zametkinapolyah.ru/zametki-o-mysql/proektirovanie-baz-dannyx-informacionnaya-izbytochnost-izbytochnost-dannyx-v-baze-dannyx-problemy-voznikayushhie-iz-za-informacionnoj-izbytochnosti.html) при проектировании базы данных, добавив отдельные поля для хранения названия ресторанов в таблицах категорий и блюд, а также названия категории в таблице блюд. Однако, на момент эксплуатации приложения, данные поля можно удалить из перечисленных таблиц - их использование ограничивается только триггерами.
 Надо также условиться, что названия ресторанов на момент импорта должны быть уникальными.
 
 Разберём для примера триггер, привязывающий сущности таблицы категорий к соответствующим ресторанам.
 
 ```
delimiter |
create trigger `link_with_restaurant` before insert on `categories`
for each row begin
    declare uid text;
    set NEW.restaurant_name = trim(NEW.restaurant_name);
    select id into uid from restaurants where name=NEW.restaurant_name;
    set NEW.restaurant_id = uid;
end;|
delimiter ;
 ```
 
 Триггер будет исполняться перед вставкой в таблицу категорий. Объявляем переменную ```uid``` типа ```text```, удаляем из названия ресторана все ненужные символы, вставляем в объявленную переменную ```id``` ресторана, имя которого равно полю ```restaurant_name``` в категориях. Завершаем применением нашей переменной к полю ```restaurant_id``` в качестве внешнего ключа.
 
 ## Импорт данных из CSV файлов в БД
 
 Все данные были напрямую импортированы из ```CSV``` файлов в соответствующие таблицы.
 Рассмотрим импорт таблицы ресторанов:
 
 ```
 load data local infile
    'restaurants.csv'
    into table restaurants
    fields terminated by ';'
    enclosed by '"'
    lines terminated by '\n'
    (id, name, image, delivery_time, delivery_price, rating);
 ```
 
 Указываем исходный файл, откуда будет происходить импорт: ```restaurant.csv```, указываем конечную таблицу ```restaurants```, определяем разделители ```;```, окружение данных ```"```, а также разделители линий, в виде знака перехода строки ```\n```, заканчивается команда определением порядка вставки столбцов из ```CSV``` файла в колонки таблицы БД, именно колонки в БД и указываются в команде.
 
 Код исходных триггеров и команд находится в файле инициализации [init.sql](https://github.com/DavidaaWoW/GlobusDelievery/blob/master/mysql/init.sql)
